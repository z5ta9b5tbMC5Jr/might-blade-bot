import random
import logging
from telebot import types

logger = logging.getLogger(__name__)

# Lista de tipos de miss√µes
MISSOES_BATALHA = [
    {
        "titulo": "Ca√ßa aos Goblins",
        "descricao": "Derrote 5 goblins que est√£o aterrorizando a vila.",
        "tipo": "batalha",
        "inimigo_alvo": "Goblin",
        "quantidade_alvo": 5,
        "recompensa": {
            "moedas": 50,
            "exp": 30,
            "item": None  # 30% de chance de ganhar um item
        }
    },
    {
        "titulo": "Elimina√ß√£o de Lobos",
        "descricao": "Elimine 3 lobos que atacam os viajantes na estrada.",
        "tipo": "batalha",
        "inimigo_alvo": "Lobo",
        "quantidade_alvo": 3,
        "recompensa": {
            "moedas": 40,
            "exp": 25,
            "item": None  # 30% de chance de ganhar um item
        }
    },
    {
        "titulo": "Amea√ßa dos Mortos-Vivos",
        "descricao": "Derrote 4 esqueletos no cemit√©rio abandonado.",
        "tipo": "batalha",
        "inimigo_alvo": "Esqueleto",
        "quantidade_alvo": 4,
        "recompensa": {
            "moedas": 60,
            "exp": 40,
            "item": None  # 40% de chance de ganhar um item
        }
    },
    {
        "titulo": "Perigo nas Minas",
        "descricao": "Elimine 2 orcs que tomaram controle das minas.",
        "tipo": "batalha",
        "inimigo_alvo": "Orc",
        "quantidade_alvo": 2,
        "recompensa": {
            "moedas": 70,
            "exp": 45,
            "item": None  # 50% de chance de ganhar um item
        }
    },
    {
        "titulo": "Guardi√µes Antigos",
        "descricao": "Derrote 2 golens de pedra nas ru√≠nas antigas.",
        "tipo": "batalha",
        "inimigo_alvo": "Golem",
        "quantidade_alvo": 2,
        "recompensa": {
            "moedas": 90,
            "exp": 60,
            "item": None  # 60% de chance de ganhar um item
        }
    }
]

def mostrar_missoes(bot, message, jogadores, db):
    """Mostra as miss√µes dispon√≠veis ou a miss√£o atual do jogador"""
    user_id = message.from_user.id
    if user_id not in jogadores:
        bot.reply_to(message, "Voc√™ ainda n√£o iniciou o jogo! Use /start primeiro.")
        return
    
    jogador = jogadores[user_id]
    
    # Verificar se o jogador j√° tem uma miss√£o ativa
    if hasattr(jogador, 'missao_ativa') and jogador.missao_ativa:
        missao = jogador.missao_ativa
        progresso = f"{missao['progresso']}/{missao['quantidade_alvo']}"
        
        # Verificar se a miss√£o foi conclu√≠da
        if missao['progresso'] >= missao['quantidade_alvo']:
            # Criar bot√£o para receber recompensa
            markup = types.InlineKeyboardMarkup()
            markup.add(types.InlineKeyboardButton("üéÅ Receber Recompensa", callback_data="receber_recompensa_missao"))
            
            bot.reply_to(message, 
                f"*Miss√£o Conclu√≠da!* üéØ\n\n"
                f"*{missao['titulo']}*\n"
                f"{missao['descricao']}\n\n"
                f"Progresso: {progresso} ‚úÖ\n\n"
                f"*Recompensas:*\n"
                f"- {missao['recompensa']['moedas']} moedas üí∞\n"
                f"- {missao['recompensa']['exp']} pontos de experi√™ncia ‚ú®\n"
                f"- Chance de item especial üéÅ\n\n"
                f"Clique no bot√£o abaixo para receber sua recompensa!",
                parse_mode="Markdown",
                reply_markup=markup
            )
        else:
            bot.reply_to(message, 
                f"*Miss√£o Atual:* üéØ\n\n"
                f"*{missao['titulo']}*\n"
                f"{missao['descricao']}\n\n"
                f"Progresso: {progresso}\n\n"
                f"*Recompensas:*\n"
                f"- {missao['recompensa']['moedas']} moedas üí∞\n"
                f"- {missao['recompensa']['exp']} pontos de experi√™ncia ‚ú®\n"
                f"- Chance de item especial üéÅ\n\n"
                f"Continue derrotando {missao['inimigo_alvo']} para completar esta miss√£o!",
                parse_mode="Markdown"
            )
    else:
        # Oferecer nova miss√£o
        nova_missao = gerar_missao(jogador)
        
        # Criar bot√µes para aceitar ou recusar
        markup = types.InlineKeyboardMarkup()
        markup.add(
            types.InlineKeyboardButton("‚úÖ Aceitar", callback_data="aceitar_missao"),
            types.InlineKeyboardButton("‚ùå Recusar", callback_data="recusar_missao")
        )
        
        bot.reply_to(message, 
            f"*Nova Miss√£o Dispon√≠vel:* üéØ\n\n"
            f"*{nova_missao['titulo']}*\n"
            f"{nova_missao['descricao']}\n\n"
            f"Objetivo: Derrotar {nova_missao['quantidade_alvo']} {nova_missao['inimigo_alvo']}(s)\n\n"
            f"*Recompensas:*\n"
            f"- {nova_missao['recompensa']['moedas']} moedas üí∞\n"
            f"- {nova_missao['recompensa']['exp']} pontos de experi√™ncia ‚ú®\n"
            f"- Chance de item especial üéÅ\n\n"
            f"Deseja aceitar esta miss√£o?",
            parse_mode="Markdown",
            reply_markup=markup
        )
        
        # Armazenar a miss√£o temporariamente
        jogador.missao_temp = nova_missao

def gerar_missao(jogador):
    """Gera uma miss√£o adequada ao n√≠vel do jogador"""
    # Selecionar miss√µes adequadas ao n√≠vel do jogador
    nivel = jogador.nivel
    
    # Filtrar miss√µes pelo n√≠vel de dificuldade
    missoes_disponiveis = MISSOES_BATALHA
    
    # Selecionar uma miss√£o aleat√≥ria
    missao = random.choice(missoes_disponiveis).copy()
    
    # Ajustar dificuldade com base no n√≠vel do jogador
    if nivel > 5:
        missao['quantidade_alvo'] = min(missao['quantidade_alvo'] + 1, 10)
        missao['recompensa']['moedas'] = int(missao['recompensa']['moedas'] * 1.5)
        missao['recompensa']['exp'] = int(missao['recompensa']['exp'] * 1.5)
    
    # Adicionar campo de progresso
    missao['progresso'] = 0
    
    return missao

def processar_aceitacao_missao(bot, call, jogadores, db):
    """Processa a aceita√ß√£o de uma miss√£o pelo jogador"""
    user_id = call.from_user.id
    jogador = jogadores[user_id]
    
    if hasattr(jogador, 'missao_temp'):
        # Definir a miss√£o como ativa
        jogador.missao_ativa = jogador.missao_temp
        delattr(jogador, 'missao_temp')
        
        # Salvar no banco de dados
        db.salvar_jogador(jogador)
        
        # Registrar atividade
        db.registrar_atividade(user_id, "aceitar_missao", {
            "missao": jogador.missao_ativa["titulo"]
        })
        
        # Notificar o jogador
        bot.answer_callback_query(call.id, "Miss√£o aceita! Boa sorte, aventureiro!")
        
        # Editar a mensagem original
        bot.edit_message_text(
            f"*Miss√£o Aceita:* ‚úÖ\n\n"
            f"*{jogador.missao_ativa['titulo']}*\n"
            f"{jogador.missao_ativa['descricao']}\n\n"
            f"Objetivo: Derrotar {jogador.missao_ativa['quantidade_alvo']} {jogador.missao_ativa['inimigo_alvo']}(s)\n\n"
            f"Use o comando /batalha para encontrar inimigos e avan√ßar em sua miss√£o!",
            chat_id=call.message.chat.id,
            message_id=call.message.message_id,
            parse_mode="Markdown"
        )
    else:
        bot.answer_callback_query(call.id, "Erro ao aceitar miss√£o. Tente novamente com /missao")

def processar_recusa_missao(bot, call, jogadores):
    """Processa a recusa de uma miss√£o pelo jogador"""
    user_id = call.from_user.id
    jogador = jogadores[user_id]
    
    if hasattr(jogador, 'missao_temp'):
        missao_recusada = jogador.missao_temp["titulo"]
        delattr(jogador, 'missao_temp')
        
        # Notificar o jogador
        bot.answer_callback_query(call.id, "Miss√£o recusada. Volte quando estiver pronto!")
        
        # Editar a mensagem original
        bot.edit_message_text(
            f"Voc√™ recusou a miss√£o *{missao_recusada}*.\n\nUse /missao para ver outras miss√µes dispon√≠veis quando estiver pronto.",
            chat_id=call.message.chat.id,
            message_id=call.message.message_id,
            parse_mode="Markdown"
        )
    else:
        bot.answer_callback_query(call.id, "Erro ao recusar miss√£o. Tente novamente com /missao")

def processar_recompensa_missao(bot, call, jogadores, db):
    """Processa a entrega de recompensa por miss√£o conclu√≠da"""
    user_id = call.from_user.id
    jogador = jogadores[user_id]
    
    if hasattr(jogador, 'missao_ativa') and jogador.missao_ativa and jogador.missao_ativa['progresso'] >= jogador.missao_ativa['quantidade_alvo']:
        missao = jogador.missao_ativa
        
        # Adicionar moedas
        jogador.moedas += missao['recompensa']['moedas']
        
        # Adicionar experi√™ncia
        subiu_nivel, msg_nivel = jogador.adicionar_experiencia(missao['recompensa']['exp'])
        
        # Verificar se ganha item (30-60% de chance dependendo da miss√£o)
        item_ganho = None
        chance_item = 0.3 + (0.1 * (missao['recompensa']['moedas'] // 20))  # Quanto maior a recompensa, maior a chance
        
        if random.random() < chance_item:
            # Itens poss√≠veis de recompensa
            itens_possiveis = [
                "Po√ß√£o de Vida M√©dia",
                "Po√ß√£o de Mana",
                "Fragmento de Cristal",
                "Pedra de Amolar",
                "Ess√™ncia M√°gica"
            ]
            
            # Adicionar itens raros para miss√µes mais dif√≠ceis
            if missao['recompensa']['moedas'] >= 70:
                itens_possiveis.extend([
                    "Po√ß√£o de Vida Grande",
                    "Pedra Elemental",
                    "Elixir de Atributos"
                ])
            
            item_ganho = random.choice(itens_possiveis)
            jogador.inventario.append(item_ganho)
        
        # Construir mensagem de recompensa
        mensagem = f"*Recompensa de Miss√£o Recebida!* üéâ\n\n"
        mensagem += f"Miss√£o: *{missao['titulo']}*\n\n"
        mensagem += f"*Voc√™ recebeu:*\n"
        mensagem += f"- {missao['recompensa']['moedas']} moedas üí∞\n"
        mensagem += f"- {missao['recompensa']['exp']} pontos de experi√™ncia ‚ú®\n"
        
        if item_ganho:
            mensagem += f"- Item: *{item_ganho}* üéÅ\n"
        
        if subiu_nivel:
            mensagem += f"\n*PARAB√âNS!* {msg_nivel} üÜô"
        
        # Remover a miss√£o ativa
        delattr(jogador, 'missao_ativa')
        
        # Salvar jogador no banco de dados
        db.salvar_jogador(jogador)
        
        # Registrar atividade
        db.registrar_atividade(user_id, "completar_missao", {
            "missao": missao["titulo"],
            "recompensa_moedas": missao['recompensa']['moedas'],
            "recompensa_exp": missao['recompensa']['exp'],
            "item_recebido": item_ganho
        })
        
        # Notificar o jogador
        bot.answer_callback_query(call.id, "Recompensa recebida!")
        
        # Editar a mensagem original
        bot.edit_message_text(
            mensagem,
            chat_id=call.message.chat.id,
            message_id=call.message.message_id,
            parse_mode="Markdown"
        )
    else:
        bot.answer_callback_query(call.id, "Erro ao receber recompensa. A miss√£o n√£o est√° conclu√≠da ou n√£o existe.") 